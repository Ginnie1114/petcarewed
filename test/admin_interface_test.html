<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å•†å®¶ç•Œé¢æ¸¬è©¦</title>
    <link rel="stylesheet" href="css/global.css">
    <link rel="stylesheet" href="css/interact.css">
    <style>
        .debug-info {
            background: #f8f9fa;
            border: 1px solid #ddd;
            padding: 15px;
            margin: 10px 0;
            border-radius: 5px;
        }
        .debug-info h3 {
            margin-top: 0;
            color: #007cba;
        }
        .success { color: #28a745; }
        .error { color: #dc3545; }
        .info { color: #17a2b8; }
    </style>
</head>
<body>

<header id="site-header">
    <div class="container">
        <h1><a href="index.html" class="logo">FunSafe</a></h1>
        <nav>
            <ul class="nav-links">
                <li><a href="index.html">é¦–é </a></li>
                <li><a href="interact.html">äº’å‹•ä¸­å¿ƒ</a></li>
            </ul>
        </nav>
    </div>
</header>

<main class="container">
    <h1>ğŸª å•†å®¶ç•Œé¢æ¸¬è©¦</h1>
    
    <div class="debug-info">
        <h3>ğŸ“Š èª¿è©¦è³‡è¨Š</h3>
        <div id="debug-output"></div>
    </div>
    
    <div class="debug-info">
        <h3>ğŸ”‘ ç™»å…¥ç‹€æ…‹</h3>
        <div id="session-status">è¼‰å…¥ä¸­...</div>
        <button onclick="checkSession()">åˆ·æ–°ç™»å…¥ç‹€æ…‹</button>
    </div>
    
    <div class="debug-info">
        <h3>ğŸ‘¥ æœƒå“¡åˆ—è¡¨</h3>
        <div id="users-list-test">è¼‰å…¥ä¸­...</div>
        <button onclick="loadUsersList()">è¼‰å…¥æœƒå“¡åˆ—è¡¨</button>
    </div>
    
    <!-- ç›´æ¥é¡¯ç¤ºç®¡ç†ç•Œé¢ -->
    <div class="admin-layout" style="display: block;">
        <div class="users-panel">
            <h3>æœƒå“¡åˆ—è¡¨</h3>
            <div class="search-box">
                <input type="text" id="user-search" placeholder="æœå°‹æœƒå“¡å§“åæˆ–Email...">
            </div>
            <div class="users-list" id="users-list">
                <p>è¼‰å…¥ä¸­...</p>
            </div>
        </div>
        
        <div class="conversation-panel">
            <div id="admin-conversation" class="admin-conversation">
                <div class="conversation-placeholder">
                    <p>è«‹é¸æ“‡å·¦å´æœƒå“¡ä»¥é–‹å§‹å°è©±</p>
                </div>
            </div>
        </div>
    </div>
</main>

<script>
    let allUsers = [];
    let currentUserId = null;
    
    function debugLog(message, type = 'info') {
        const debugOutput = document.getElementById('debug-output');
        const timestamp = new Date().toLocaleTimeString();
        const className = type === 'error' ? 'error' : (type === 'success' ? 'success' : 'info');
        debugOutput.innerHTML += `<div class="${className}">[${timestamp}] ${message}</div>`;
        console.log(`[${timestamp}] ${message}`);
    }
    
    async function checkSession() {
        try {
            debugLog('æ­£åœ¨æª¢æŸ¥ç™»å…¥ç‹€æ…‹...');
            const response = await fetch('php/api/get_session_status.php');
            const data = await response.json();
            
            const statusDiv = document.getElementById('session-status');
            if (data.loggedIn) {
                statusDiv.innerHTML = `
                    <div class="success">âœ… å·²ç™»å…¥</div>
                    <p><strong>å§“å:</strong> ${data.name}</p>
                    <p><strong>è§’è‰²:</strong> ${data.role}</p>
                    <p><strong>æœªè®€è¨Šæ¯:</strong> ${data.unread_messages}</p>
                `;
                debugLog(`ç™»å…¥æˆåŠŸ: ${data.name} (${data.role})`, 'success');
                
                if (data.role === 'shop') {
                    debugLog('æª¢æ¸¬åˆ°å•†å®¶è§’è‰²ï¼Œè¼‰å…¥å•†å®¶åŠŸèƒ½', 'success');
                    loadUsersList();
                } else {
                    debugLog('éå•†å®¶è§’è‰²ï¼Œç„¡æ³•ä½¿ç”¨å•†å®¶åŠŸèƒ½', 'error');
                }
            } else {
                statusDiv.innerHTML = '<div class="error">âŒ æœªç™»å…¥</div>';
                debugLog('ç”¨æˆ¶æœªç™»å…¥', 'error');
            }
        } catch (error) {
            debugLog(`æª¢æŸ¥ç™»å…¥ç‹€æ…‹éŒ¯èª¤: ${error.message}`, 'error');
            document.getElementById('session-status').innerHTML = '<div class="error">âŒ æª¢æŸ¥å¤±æ•—</div>';
        }
    }
    
    async function loadUsersList() {
        try {
            debugLog('æ­£åœ¨è¼‰å…¥æœƒå“¡åˆ—è¡¨...');
            const response = await fetch('php/admin_get_users.php');
            const data = await response.json();
            
            const usersListTestDiv = document.getElementById('users-list-test');
            const usersListDiv = document.getElementById('users-list');
            
            if (data.success) {
                allUsers = data.users;
                debugLog(`æˆåŠŸè¼‰å…¥ ${data.users.length} å€‹æœƒå“¡`, 'success');
                
                // é¡¯ç¤ºåœ¨æ¸¬è©¦å€åŸŸ
                usersListTestDiv.innerHTML = data.users.map(user => `
                    <div style="border: 1px solid #ddd; padding: 10px; margin: 5px 0;">
                        <strong>${user.name}</strong> (ID: ${user.id})<br>
                        ğŸ“§ ${user.email}<br>
                        ğŸ’¬ æœªè®€: ${user.unread_count || 0} å‰‡
                    </div>
                `).join('');
                
                // é¡¯ç¤ºåœ¨å¯¦éš›ç•Œé¢
                renderUsersList(data.users);
                
            } else {
                debugLog(`è¼‰å…¥æœƒå“¡åˆ—è¡¨å¤±æ•—: ${data.message}`, 'error');
                if (data.debug) {
                    debugLog(`èª¿è©¦è³‡è¨Š: ${JSON.stringify(data.debug)}`, 'error');
                }
                usersListTestDiv.innerHTML = '<div class="error">è¼‰å…¥å¤±æ•—</div>';
                usersListDiv.innerHTML = '<p>è¼‰å…¥å¤±æ•—</p>';
            }
        } catch (error) {
            debugLog(`è¼‰å…¥æœƒå“¡åˆ—è¡¨éŒ¯èª¤: ${error.message}`, 'error');
            document.getElementById('users-list-test').innerHTML = '<div class="error">è¼‰å…¥éŒ¯èª¤</div>';
            document.getElementById('users-list').innerHTML = '<p>è¼‰å…¥éŒ¯èª¤</p>';
        }
    }
    
    function renderUsersList(users) {
        const container = document.getElementById('users-list');
        if (users.length === 0) {
            container.innerHTML = '<p>ç›®å‰æ²’æœ‰æœƒå“¡</p>';
            return;
        }

        container.innerHTML = users.map(user => `
            <div class="user-item" data-user-id="${user.id}">
                <strong>${user.name}</strong>
                <div>${user.email}</div>
                <small>æœ€å¾Œè¨Šæ¯: ${user.last_message_time || 'ç„¡'}</small>
            </div>
        `).join('');

        // ç‚ºç”¨æˆ¶é …ç›®æ·»åŠ é»æ“Šäº‹ä»¶
        document.querySelectorAll('.user-item').forEach(item => {
            item.addEventListener('click', function() {
                document.querySelectorAll('.user-item').forEach(i => i.classList.remove('active'));
                this.classList.add('active');
                
                const userId = this.dataset.userId;
                currentUserId = userId;
                debugLog(`é¸æ“‡äº†æœƒå“¡ ID: ${userId}`, 'info');
                loadAdminConversation(userId);
            });
        });
    }
    
    async function loadAdminConversation(userId) {
        try {
            debugLog(`æ­£åœ¨è¼‰å…¥æœƒå“¡ ${userId} çš„å°è©±...`);
            const response = await fetch(`php/admin_get_user_data.php?user_id=${userId}`);
            const data = await response.json();
            
            if (data.success) {
                debugLog(`æˆåŠŸè¼‰å…¥æœƒå“¡å°è©±ï¼Œå…± ${data.messages.length} å‰‡è¨Šæ¯`, 'success');
                renderAdminConversation(data);
            } else {
                debugLog(`è¼‰å…¥å°è©±å¤±æ•—: ${data.message}`, 'error');
                document.getElementById('admin-conversation').innerHTML = '<p>è¼‰å…¥å°è©±å¤±æ•—</p>';
            }
        } catch (error) {
            debugLog(`è¼‰å…¥å°è©±éŒ¯èª¤: ${error.message}`, 'error');
            document.getElementById('admin-conversation').innerHTML = '<p>è¼‰å…¥å¤±æ•—</p>';
        }
    }
    
    function renderAdminConversation(data) {
        const container = document.getElementById('admin-conversation');
        
        container.innerHTML = `
            <div class="admin-user-info">
                <h4>æœƒå“¡è³‡è¨Š</h4>
                <p><strong>å§“åï¼š</strong>${data.user.name}</p>
                <p><strong>Emailï¼š</strong>${data.user.email}</p>
            </div>
            
            <div class="admin-pets-list">
                <h4>å¯µç‰©åˆ—è¡¨</h4>
                ${data.pets.length === 0 ? '<p>è©²æœƒå“¡å°šæœªè¨»å†Šå¯µç‰©</p>' : 
                  data.pets.map(pet => `
                    <span class="pet-tag-admin">${pet.name} (${pet.type || 'æœªçŸ¥'})</span>
                  `).join('')
                }
            </div>
            
            <div class="conversation-messages">
                <h4>å°è©±è¨˜éŒ„</h4>
                <div class="messages-container" style="max-height: 400px; overflow-y: auto;">
                    ${renderAdminMessages(data.messages)}
                </div>
            </div>
            
            <div class="admin-reply-form">
                <h4>å›è¦†è¨Šæ¯</h4>
                <form id="admin-reply-form">
                    <textarea id="admin-reply-content" placeholder="è¼¸å…¥å›è¦†å…§å®¹..." required rows="3"></textarea>
                    <button type="submit">å‚³é€å›è¦†</button>
                </form>
            </div>
        `;

        // ç¶å®šå›è¦†è¡¨å–®äº‹ä»¶
        document.getElementById('admin-reply-form').addEventListener('submit', handleAdminReply);
    }
    
    function renderAdminMessages(messages) {
        if (messages.length === 0) {
            return '<p>ç›®å‰æ²’æœ‰å°è©±è¨˜éŒ„</p>';
        }

        return messages.map(message => `
            <div class="message-card ${message.sender === 'user' ? 'received' : 'sent'}">
                <div class="message-content">
                    <div class="message-header">
                        <strong>${message.sender === 'user' ? 'æœƒå“¡' : 'å®¢æœ'}</strong>
                        ${message.pet_name ? `<span class="pet-tag">${message.pet_name}</span>` : ''}
                        <span class="message-time">${message.created_at}</span>
                    </div>
                    <p>${message.content.replace(/\n/g, '<br>')}</p>
                </div>
            </div>
        `).join('');
    }
    
    async function handleAdminReply(e) {
        e.preventDefault();
        
        const content = document.getElementById('admin-reply-content').value.trim();
        
        if (!content) {
            alert('è«‹è¼¸å…¥å›è¦†å…§å®¹');
            return;
        }
        
        try {
            debugLog(`æ­£åœ¨ç™¼é€å›è¦†çµ¦æœƒå“¡ ${currentUserId}...`);
            
            const formData = new FormData();
            formData.append('user_id', currentUserId);
            formData.append('content', content);

            const response = await fetch('php/admin_send_message.php', {
                method: 'POST',
                body: formData
            });
            
            const data = await response.json();
            
            if (data.success) {
                debugLog('å›è¦†ç™¼é€æˆåŠŸ', 'success');
                document.getElementById('admin-reply-form').reset();
                loadAdminConversation(currentUserId); // é‡æ–°è¼‰å…¥å°è©±
                alert('å›è¦†å·²é€å‡ºï¼');
            } else {
                debugLog(`å›è¦†ç™¼é€å¤±æ•—: ${data.message}`, 'error');
                alert(data.message || 'å‚³é€å¤±æ•—');
            }
        } catch (error) {
            debugLog(`å›è¦†ç™¼é€éŒ¯èª¤: ${error.message}`, 'error');
            alert('å‚³é€å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦');
        }
    }
    
    // é é¢è¼‰å…¥æ™‚è‡ªå‹•æª¢æŸ¥
    window.addEventListener('load', function() {
        debugLog('é é¢è¼‰å…¥å®Œæˆ', 'info');
        checkSession();
    });
</script>

</body>
</html>
